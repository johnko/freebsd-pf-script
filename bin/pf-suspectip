#!/bin/sh

blockedports(){
    echo "8888|\
10200|\
51127|\
8090|\
8083|\
6004|\
6003|\
5000|\
1080|\
80|\
9200|\
" | sed 's;|$;;'
}

ports=$( blockedports )

blacklist=$( pf-table show black | awk '{print $1}' | tr "\n" '|' | sed 's;|$;;' )
if [ "x" = "x$blacklist" ]; then
    blacklist="blah"
fi
sshbanlist=$( pf-table show sshban | awk '{print $1}' | tr "\n" '|' | sed 's;|$;;' )
if [ "x" = "x$sshbanlist" ]; then
    sshbanlist="blah"
fi

myip=$( echo $SSH_CONNECTION | awk '{print $1}' )

sketchyhosts(){
    pf-log 2>/dev/null | grep -v "$myip" | egrep "($ports)" | egrep -v "($blacklist)" | egrep -v "($sshbanlist)" | awk '{print $9}' | awk -F. '{print $1"."$2"."$3"."$4}' | sort | uniq -c
}

countblockedhosts(){
    pf-log 2>/dev/null | grep -v "$myip" | egrep -v "($blacklist)" | egrep -v "($sshbanlist)" | awk '{print $9}' | awk -F. '{print $1"."$2"."$3"."$4}' | sort | uniq -c | sort | tail
}

sketchyhosts | while read count ip ; do
    echo $count $ip
    pf-log 2>/dev/null | grep $ip
done

echo "================="

countblockedhosts | while read count ip ; do
    echo $count $ip
    pf-log 2>/dev/null | grep $ip
done
