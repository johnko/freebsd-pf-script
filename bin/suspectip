#!/bin/sh

blockedports(){
    echo "8888|\
10200|\
51127|\
8090|\
8083|\
6004|\
6003|\
5000|\
" | sed 's;|$;;'
}

ports=$( blockedports )

blacklist=$( pf-table show black | awk '{print $1}' | tr "\n" '|' | sed 's;|$;;' )

myip=$( echo $SSH_CONNECTION | awk '{print $1}' )

sketchyhosts(){
    pf-log 2>/dev/null | egrep "($ports)" | egrep -v "($blacklist)" | awk '{print $9}' | awk -F. '{print $1"."$2"."$3"."$4}' | sort | uniq -c
}

countblockedhosts(){
    pf-log 2>/dev/null | grep -v "$myip\." | egrep -v "($blacklist)" | awk '{print $9}' | awk -F. '{print $1"."$2"."$3"."$4}' | sort | uniq -c | sort | tail
}

sketchyhosts | while read count ip ; do
    echo $count $ip
    pf-log 2>/dev/null | grep $ip
    read yesno
    if [ "xy" = "x$yesno" ]; then
	pf-table add black $ip
    fi
done

counthosts | while read count ip ; do
    echo $count $ip
    pf-log 2>/dev/null | grep $ip
    read yesno
    if [ "xy" = "x$yesno" ]; then
	pf-table add black $ip
    fi
done
